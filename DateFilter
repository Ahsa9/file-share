import QtQuick 2.15
import QtQuick.Controls 2.15
import QtQuick.Layouts 1.15

Rectangle {
    id: filterPopup
    width: 1054
    height: 285
    radius: 24
    color: "#007D99"
    z: 100
    border.color: "#FFFFFF"
    border.width: 1

    signal cancelClicked
    signal submitClicked(string startDate, string endDate)

    // === DATE INITIALIZATION ===
    Component.onCompleted: {
        var today = new Date()
        var yesterday = new Date()
        yesterday.setDate(today.getDate() - 1)

        // Yesterday
        root.startDayIndex = yesterday.getDate() - 1
        root.startMonthIndex = yesterday.getMonth()
        root.startYearIndex = yesterday.getFullYear() - root.baseYear

        // Today
        root.endDayIndex = today.getDate() - 1
        root.endMonthIndex = today.getMonth()
        root.endYearIndex = today.getFullYear() - root.baseYear
    }

    function getDaysInMonth(monthIndex, year) {
        return new Date(year, monthIndex + 1, 0).getDate()
    }

    function pad(n) {
        return n < 10 ? "0" + n : n
    }

    property int baseYear: 2020
    property var yearModel: {
        var arr = []
        for (var i = 0; i < 30; i++)
            arr.push(baseYear + i)
        return arr
    }

    MouseArea {
        anchors.fill: parent
        hoverEnabled: true
    }

    Component {
        id: colonSeparator
        Item {
            width: 18
            height: 47
            Text {
                text: ":"
                color: "white"
                font.bold: true
                font.pixelSize: 50
                anchors.centerIn: parent
                verticalAlignment: Text.AlignVCenter
            }
        }
    }

    Component {
        id: dateSlotButton
        Button {
            property var slotModel: 31
            property int slotIndex: 0
            property string displayValue: "01"
            property var confirmCallback: null
            width: 90
            height: 60
            background: Rectangle {
                color: "#15000000"
                border.color: "#AACCFF"
                radius: 4
                opacity: parent.down ? 0.5 : 1.0
            }
            contentItem: Text {
                text: parent.displayValue
                color: "white"
                font.bold: true
                font.pixelSize: 32
                horizontalAlignment: Text.AlignHCenter
                verticalAlignment: Text.AlignVCenter
            }
            onClicked: bigSlotPopup.open(slotModel, slotIndex, confirmCallback)
        }
    }

    Item {
        id: slotsContainer
        width: 990
        height: 115
        anchors.top: parent.top
        anchors.topMargin: 32
        anchors.horizontalCenter: parent.horizontalCenter

        Row {
            id: dateSelectionRow
            spacing: 60
            anchors.centerIn: parent

            // --- FROM SECTION (Yesterday) ---
            Row {
                spacing: 20
                Text {
                    text: "From"
                    color: "#0FE6EF"
                    font.family: "Roboto"
                    font.pixelSize: 40
                    anchors.verticalCenter: parent.verticalCenter
                }
                Row {
                    spacing: 8
                    anchors.verticalCenter: parent.verticalCenter
                    Loader {
                        sourceComponent: dateSlotButton
                        onLoaded: {
                            item.width = 74
                            item.slotModel = Qt.binding(
                                        () => getDaysInMonth(
                                            root.startMonthIndex,
                                            yearModel[root.startYearIndex]))
                            item.slotIndex = Qt.binding(
                                        () => root.startDayIndex)
                            item.displayValue = Qt.binding(
                                        () => pad(root.startDayIndex + 1))
                            item.confirmCallback = function (idx) {
                                root.startDayIndex = idx
                            }
                        }
                    }
                    Loader {
                        sourceComponent: colonSeparator
                    }
                    Loader {
                        sourceComponent: dateSlotButton
                        onLoaded: {
                            item.width = 80
                            item.slotModel = 12
                            item.slotIndex = Qt.binding(
                                        () => root.startMonthIndex)
                            item.displayValue = Qt.binding(
                                        () => pad(root.startMonthIndex + 1))
                            item.confirmCallback = function (idx) {
                                root.startMonthIndex = idx
                            }
                        }
                    }
                    Loader {
                        sourceComponent: colonSeparator
                    }
                    Loader {
                        sourceComponent: dateSlotButton
                        onLoaded: {
                            item.width = 110
                            item.slotModel = filterPopup.yearModel
                            item.slotIndex = Qt.binding(
                                        () => root.startYearIndex)
                            item.displayValue = Qt.binding(
                                        () => yearModel[root.startYearIndex])
                            item.confirmCallback = function (idx) {
                                root.startYearIndex = idx
                            }
                        }
                    }
                }
            }

            // --- TO SECTION (Today) ---
            Row {
                spacing: 20
                Text {
                    text: "To"
                    color: "#0FE6EF"
                    font.family: "Roboto"
                    font.pixelSize: 40
                    anchors.verticalCenter: parent.verticalCenter
                }
                Row {
                    spacing: 8
                    anchors.verticalCenter: parent.verticalCenter
                    Loader {
                        sourceComponent: dateSlotButton
                        onLoaded: {
                            item.width = 74
                            item.slotModel = Qt.binding(
                                        () => getDaysInMonth(
                                            root.endMonthIndex,
                                            yearModel[root.endYearIndex]))
                            item.slotIndex = Qt.binding(() => root.endDayIndex)
                            item.displayValue = Qt.binding(
                                        () => pad(root.endDayIndex + 1))
                            item.confirmCallback = function (idx) {
                                root.endDayIndex = idx
                            }
                        }
                    }
                    Loader {
                        sourceComponent: colonSeparator
                    }
                    Loader {
                        sourceComponent: dateSlotButton
                        onLoaded: {
                            item.width = 80
                            item.slotModel = 12
                            item.slotIndex = Qt.binding(
                                        () => root.endMonthIndex)
                            item.displayValue = Qt.binding(
                                        () => pad(root.endMonthIndex + 1))
                            item.confirmCallback = function (idx) {
                                root.endMonthIndex = idx
                            }
                        }
                    }
                    Loader {
                        sourceComponent: colonSeparator
                    }
                    Loader {
                        sourceComponent: dateSlotButton
                        onLoaded: {
                            item.width = 110
                            item.slotModel = filterPopup.yearModel
                            item.slotIndex = Qt.binding(() => root.endYearIndex)
                            item.displayValue = Qt.binding(
                                        () => yearModel[root.endYearIndex])
                            item.confirmCallback = function (idx) {
                                root.endYearIndex = idx
                            }
                        }
                    }
                }
            }
        }
    }

    Rectangle {
        id: buttonsContainer
        width: 966
        height: 74
        color: "transparent"
        anchors.bottom: parent.bottom
        anchors.bottomMargin: 24
        anchors.horizontalCenter: parent.horizontalCenter
        Row {
            anchors.centerIn: parent
            spacing: 12
            Button {
                text: "Cancel"
                width: 460
                height: 70
                background: Rectangle {
                    color: parent.down
                           || parent.hovered ? "white" : "transparent"
                    border.color: "white"
                    radius: 10
                }
                contentItem: Text {
                    text: parent.text
                    color: parent.down || parent.hovered ? "#007D99" : "white"
                    font.pixelSize: 26
                    horizontalAlignment: Text.AlignHCenter
                    verticalAlignment: Text.AlignVCenter
                }
                onClicked: cancelClicked()
            }
            Button {
                text: "Submit"
                width: 460
                height: 70
                background: Rectangle {
                    color: parent.down
                           || parent.hovered ? "white" : "transparent"
                    border.color: "white"
                    radius: 10
                }
                contentItem: Text {
                    text: parent.text
                    color: parent.down || parent.hovered ? "#007D99" : "white"
                    font.pixelSize: 26
                    horizontalAlignment: Text.AlignHCenter
                    verticalAlignment: Text.AlignVCenter
                }
                onClicked: {
                    var sD = pad(root.startDayIndex
                                 + 1), sM = pad(
                                           root.startMonthIndex
                                           + 1), sY = yearModel[root.startYearIndex]
                    var eD = pad(root.endDayIndex + 1), eM = pad(
                                                            root.endMonthIndex
                                                            + 1), eY = yearModel[root.endYearIndex]
                    var startDateISO = sY + "-" + sM + "-" + sD
                    var endDateISO = eY + "-" + eM + "-" + eD
                    filterPopup.submitClicked(startDateISO, endDateISO)
                }
            }
        }
    }
}
